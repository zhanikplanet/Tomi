<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exhibitions</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link type="Image/x-icon" href="выс.webp" rel="icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .dialog {
      width: 400px;
      padding: 20px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .close-btn {
      float: right;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header class="p-3 mb-3 border-bottom">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
        <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 link-body-emphasis text-decoration-none">
          <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap">
            <use xlink:href="#bootstrap"></use>
          </svg>
        </a>

        <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
          <li><a href="#" class="nav-link px-2 disabled">Main</a></li>
          <li><a href="#" class="nav-link px-2 link-body-emphasis" id="adminPage">Users</a></li>
        </ul>
        <div class="dropdown text-end">
          <a href="#" class="d-block link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown"
            aria-expanded="false">
            <img src="https://github.com/mdo.png" alt="mdo" width="32" height="32" class="rounded-circle">
          </a>
          <ul class="dropdown-menu text-small">
            <li><a class="dropdown-item" href="/profile.html">Profile</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="javascript:void(0)" id="logout">Sign out</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>
  <div class="main">
    <div id="myCarousel" class="carousel slide mb-6" data-bs-ride="carousel">
      <div class="carousel-inner">
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>
    <button type="button" id="openDialogButton">Create Image</button>
    <dialog id="createImageDialog" class="dialog">
      <div class="dialog-content">
        <button id="cancelSendBtn" class="close-btn">×</button>
        <h2>Create Image</h2>
        <form id="sendEmailForm">
          <div class="form-group">
            <label for="Title">Title</label>
            <input type="text" id="title" name="Title" required>
          </div>
          <div class="form-group">
            <label for="Description">Description:</label>
            <input type="text" id="description" name="description" required>
          </div>
          <div class="form-group">
            <label for="URL">URL:</label>
            <input type="text" id="url" name="url" required>
          </div>
          <button type="submit">Create</button>
        </form>
      </div>
    </dialog>
    <dialog id="updateImageDialog" class="dialog">
      <div class="dialog-content">
        <button id="cancelUpdateBtn" class="close-btn">×</button>
        <h2>Update Image</h2>
        <form id="sendUpdateForm">
          <div class="form-group">
            <label for="Title">Title</label>
            <input type="text" id="updateTitle" name="Title" required>
          </div>
          <div class="form-group">
            <label for="Description">Description:</label>
            <input type="text" id="updateDescription" name="description" required>
          </div>
          <div class="form-group">
            <label for="URL">URL:</label>
            <input type="text" id="updateUrl" name="url" required>
          </div>
          <button type="submit">Update</button>
        </form>
      </div>
    </dialog>
  </div>
  <div class="container">
    <footer class="py-3 my-4">
      <ul class="nav justify-content-center border-bottom pb-3 mb-3">
        <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Home</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Features</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Pricing</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">FAQs</a></li>
        <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">About</a></li>
      </ul>
      <p class="text-center text-body-secondary">© 2024 IT-2201, Tomiris</p>
    </footer>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const token = localStorage.getItem('token');
    if (token) {
      // console.log('Token:', token);
    } else {
      console.error('Token not found in cookie');
    }
    document.addEventListener('DOMContentLoaded',function(){
      updateImageDialog.style.display = 'none';
      createImage.style.display = 'none';

    })
    document.getElementById('adminPage').addEventListener('click', async function () {
      const user = await getEmailFromToken(token)
      const role = user.userInfo.role
      if (role == 'admin')
        window.location.href = '/admin.html'
      else
        alert('you dont have permission')
    })

    document.getElementById('logout').addEventListener('click', function () {
      logout();
    });

    function logout() {
      localStorage.removeItem('token');
      alert('You have been signed out.');
      window.location.href = '/index.html';
    }

    async function getCarouselItems() {
      try {
        const response = await fetch(`https://localhost:3000/api/images`);
        const data = await response.json();
        return data;
      } catch (err) {
        console.error('Error:', err);
      }
    }

    function generateCarouselHTML(items) {
      let html = '';
      items.forEach((item, index) => {
        const activeClass = index === 0 ? 'active' : '';
        html += /*html*/`
        <div class="carousel-item ${activeClass}">
            <img src="${item.url}" class="d-block w-100" alt="Slide ${index + 1}">
            <div class="carousel-caption">
                <h5>${item.title}</h5>
                <p>${item.description}</p>
                <button class="btn btn-info btn-sm update-btn" data-id="${item._id}">Update</button>
                <button class="btn btn-danger btn-sm delete-btn" data-id="${item._id}">Delete</button>
            </div>
        </div>
      `;
      });
      return html;
    }




    async function handleUpdateButtonClick(event) {
      const user = await getEmailFromToken(token)
      const role = user.userInfo.role
      if (role == 'moderator') {
        const itemId = event.target.dataset.id;
        console.log(itemId)
        openUpdateDialog(itemId);
      } else {
        alert('You do not have permission to update carousel items.');
      }
    }

    async function handleDeleteButtonClick(event) {
      const user = await getEmailFromToken(token)
      const role = user.userInfo.role
      if (role == 'moderator') {
        const id = event.target.dataset.id;
        deleteItem(id)
      } else {
        alert('You do not have permission to update carousel items.');
      }
    }


   const updateImageDialog = document.getElementById('updateImageDialog');
    const cancelUpdateBtn = document.getElementById('cancelUpdateBtn');

    const sendUpdateForm = document.getElementById('sendUpdateForm');





    function openUpdateDialog(itemId) {

      updateImageDialog.dataset.id = itemId;


      updateImageDialog.style.display = 'block';
    }


    cancelUpdateBtn.addEventListener('click', () => {

      updateImageDialog.style.display = 'none';
    });

    sendUpdateForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const id = updateImageDialog.dataset.id;
      const title = document.getElementById('updateTitle').value;
      const description = document.getElementById('updateDescription').value;
      const url = document.getElementById('updateUrl').value;
      console.log(title, description, url)
      await updateItem(id, title, description, url);
    });



    async function deleteItem(id) {
      console.log(id)
      try {
        const response = await fetch(`https://localhost:3000/api/deleteImage/${id}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        console.log(data.message);

        initializeCarousel();
      } catch (err) {
        console.error('Error: ', err);
      }
    }

    async function updateItem(id, title, description, url) {
      try {
        const response = await fetch(`https://localhost:3000/api/updateImage/${id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id, title, description, url })
        });

        initializeCarousel();
      } catch (err) {
        console.error('Error: ', err);
      }
    }

    document.querySelector('.carousel-inner').addEventListener('click', (event) => {
      if (event.target.classList.contains('update-btn')) {
        handleUpdateButtonClick(event);
      } else if (event.target.classList.contains('delete-btn')) {
        handleDeleteButtonClick(event);
      }
    });

    async function initializeCarousel() {
      const carousel = document.getElementById('myCarousel');
      const carouselInner = carousel.querySelector('.carousel-inner');

      const items = await getCarouselItems();
      //console.log(items);

      const carouselHTML = generateCarouselHTML(items);
      //console.log(carouselHTML);

      carouselInner.innerHTML = carouselHTML;
    }



    async function createCarouselItem(title, description, url) {
      try {
        const response = await fetch(`https://localhost:3000/api/image`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, description, url })
        });
        const data = await response.json();
        createImage.style.display = 'none';
        //console.log(data);
      } catch (err) {
        console.error('Error: ', err);
      }
    }

    const openDialogBtn = document.getElementById('openDialogButton');
    const createImage = document.getElementById('createImageDialog');
    const cancelSendBtn = document.getElementById('cancelSendBtn');
    const sendEmailForm = document.getElementById('sendEmailForm');

    openDialogBtn.addEventListener('click', () => {
      openDialog();
    });

    async function openDialog() {
      const user = await getEmailFromToken(token)
      console.log(user)
      const role = user.userInfo.role
      if (role == 'moderator') {
        createImage.style.display = 'block';
      } else {
        alert('You do not have permission to update carousel items.');
      }
    }

    cancelSendBtn.addEventListener('click', () => {
      createImage.style.display = 'none';
    });

    sendEmailForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const url = document.getElementById('url').value;
      await createCarouselItem(title, description, url);
    });

    async function getEmailFromToken(token) {
    try {
        const tokenParts = token.split('.');
        const decodedBody = atob(tokenParts[1]);
        const tokenBody = JSON.parse(decodedBody);
        return await userInfo(tokenBody.email, token);
    } catch (error) {
        console.error('Error:', error);
        return null;
    }
}


    async function userInfo(email, token) {
    try {
        const response = await fetch(`https://localhost:3000/api/getUser/${email}`);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error getting user info:', error);
        return null;
    }
}
    initializeCarousel();
  </script>

</body>

</html>